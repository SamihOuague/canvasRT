(()=>{"use strict";function t(t){let i=Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z);return 0===i?{x:0,y:0,z:0}:{x:t.x/i,y:t.y/i,z:t.z/i}}function i(t,i){return{x:t.x*i,y:t.y*i,z:t.z*i}}function s(t,i){return t.x*i.x+t.y*i.y+t.z*i.z}function n(t,i){return{x:t.x-i.x,y:t.y-i.y,z:t.z-i.z}}function r(t){return t*Math.PI/180}function e(t,i){return{x:t.x+i.x,y:t.y+i.y,z:t.z+i.z}}function h(t,i){return{x:t.y*i.z-t.z*i.y,y:t.z*i.x-t.x*i.z,z:t.x*i.y-t.y*i.x}}class o{constructor(t,i){this.from=t,this.direction=i,this.hit={distance:1e4}}ft_ray_direction(t){let i,s,n;return n=70,i=1*((t.x+.5)/250*2-1),i*=Math.tan(r(35)),s=(t.y+.5)/250*2-1,s*=Math.tan(r(35)),{x:i,y:s,z:1}}hasIntersection(t,i){return t.ft_has_intersection(this)?"#"+i.ft_light(this,t):"#000000"}shadowHasIntersection(t,i){let s=null;for(let n in t){let r=new o(this.from,this.direction);t[n]!==i&&t[n].ft_has_intersection(r)&&(null==s||r.hit.distance<s.hit.distance)&&(s=r)}return null!=s&&s.hit.distance<0?null:s}}const c=o;let a=new class{constructor(t,i){this.radius=i,this.origin=t,this.color={x:255,y:20,z:25}}ft_sphere_normal(s){let r,e;return e=i(s.direction,s.hit.distance),r=n(e,n(this.origin,s.from)),s.hit.normal=t(r),s.hit.pixel={x:this.color.x,y:this.color.y,z:this.color.z},1}ft_has_intersection(t){let i=n(t.from,this.origin),r={x:s(t.direction,t.direction),y:2*s(t.direction,i),z:s(i,i)-Math.pow(this.radius,2)},e=Math.pow(r.y,2)-r.x*r.z*4,h=[0,0];return e<0?0:(h[0]=-r.y/(2*r.x),e>0&&(e=Math.sqrt(e)),h[0]=(-r.y+e)/(2*r.x),h[1]=(-r.y-e)/(2*r.x),h[0]<0&&h[1]<0?0:(h[0]>h[1]&&h[1]>0&&(h[0]=h[1]),t.hit.distance=h[0],this.ft_sphere_normal(t)))}}({x:0,y:-10,z:55},10),l=[new class{constructor(t,i){this.direction=t,this.point=i,this.color={x:120,y:255,z:55}}ft_has_intersection(r){let e,h,o;return o=s(this.direction,r.direction),Math.abs(o)<=.001?0:(h=s(this.direction,n(this.point,r.from)),e=h/o,r.hit.distance=e,r.hit.normal=t(this.direction),r.hit.pixel=this.color,s(r.direction,r.hit.normal)>0&&(r.hit.normal=i(r.hit.normal,-1)),1)}}({x:0,y:1,z:0},{x:10,y:-10,z:20}),new class{constructor(i,s,n,r){this.radius=r,this.height=n,this.axis=t(s),this.origin=i,this.color={x:25,y:155,z:255}}ft_caps_normal_intersection(t,r,e){let h,o=n(this.origin,t.from);return h=n(i(t.direction,r[0]),e),t.hit.distance=r[0],t.hit.normal=this.axis,s(h,h)<Math.pow(this.radius,2)&&r[0]>0?(s(t.direction,t.hit.normal)>0&&(t.hit.normal=i(t.hit.normal,-1)),1):(h=n(i(t.direction,r[1]),o),t.hit.normal=this.axis,t.hit.distance=r[1],s(h,h)<Math.pow(this.radius,2)&&r[1]>0?(s(t.direction,t.hit.normal)>0&&(t.hit.normal=i(t.hit.normal,-1)),1):0)}ft_cy_normal(t){let r,e,h,o=n(this.origin,t.from);return e=i(t.direction,t.hit.distance),h=s(this.axis,n(e,o)),r=n(n(e,i(this.axis,h)),o),r=i(r,1/Math.sqrt(s(r,r))),t.hit.normal=r,1}ft_caps_intersection(t){let r,h,o,c=[0,0],a=n(this.origin,t.from);return r=e(a,i(this.axis,this.height)),h=s(this.axis,t.direction),Math.abs(h)<=.001?0:(o=s(this.axis,r),c[0]=o/h,o=s(this.axis,a),c[1]=o/h,this.ft_caps_normal_intersection(t,c,r)?1:0)}ft_cylinder_vars_init(t,i,r){let e=n(this.origin,r.from);t=h(r.direction,this.axis),i.x=s(t,t),i.y=s(t,h(e,this.axis)),i.z=i.x*Math.pow(this.radius,2)-s(this.axis,this.axis)*Math.pow(s(e,t),2)}ft_has_intersection(t){let r={x:0,y:0,z:0},e=[0,0],h=n(this.origin,t.from);return t.hit.pixel=this.color,this.ft_cylinder_vars_init(void 0,r,t),r.z<0||0==r.x?this.ft_caps_intersection(t):(e[0]=(r.y+Math.sqrt(r.z))/r.x,e[1]=(r.y-Math.sqrt(r.z))/r.x,e[0]<0&&e[1]<0?this.ft_caps_intersection(t):(e[0]>e[1]&&e[1]>0&&(e[0]=e[1]),e[1]=s(this.axis,n(i(t.direction,e[0]),h)),e[1]<=0||e[1]>=this.height?this.ft_caps_intersection(t):(t.hit.distance=e[0],this.ft_cy_normal(t))))}}({x:5,y:-10,z:30},{x:1,y:1,z:-1},10,3),a];new class{constructor(t,i,s){this.objects=t,this.light=i,this.ctx=s,this.width=250,this.height=250}getPixel(t){let i=1e4,s="#000000",n="#000000",r=new c(t.from,t.direction);for(let e in this.objects)n=r.hasIntersection(this.objects[e],this.light,this.objects),"#000000"!=n&&r.hit.distance>1&&r.hit.distance<i&&(s=n,i=r.hit.distance),e<this.objects.length-1&&(r=new c(t.from,t.direction));return s}render(){let t,i,s;this.ctx.clearRect(0,0,this.width,this.height),this.ctx.fillStyle="#000000";for(let n=0;n<62500;n++)t=n%250,i=Math.floor(n/250),s=new c({x:0,y:0,z:0},{x:t,y:i,z:1}),s.direction=s.ft_ray_direction(s.direction),this.ctx.fillStyle=this.getPixel(s),this.ctx.fillRect(t,249-i,1,1)}}(l,new class{constructor(t,i,s,n,r){this.origin=t,this.intensity=i,this.ambient=s,this.color=n,this.shapes=r}ft_is_shadow(r,h,o){let a,l,x={},d=e(this.origin,i(r.direction,1e-6));return a=e(r.from,i(r.direction,r.hit.distance)),x.direction=t(n(d,a)),x.from=a,x=new c(x.from,x.direction),d=n(d,a),l=Math.sqrt(s(d,d)),x=x.shadowHasIntersection(h,o),x&&x.hit.distance>0?1:0}ft_light(r,h){let o,c,a,l,x;return o=e(r.from,i(r.direction,r.hit.distance)),c=t(n(this.origin,o)),a=r.hit.normal,x=s(c,a),(x<0||this.ft_is_shadow(r,this.shapes,h))&&(x=0),x*=this.intensity,l={x:x+this.ambient*(this.color.x/255),y:x+this.ambient*(this.color.y/255),z:x+this.ambient*(this.color.z/255)},l.x>1&&(l.x=1),l.y>1&&(l.y=1),l.z>1&&(l.z=1),function(t,i,s){let n=[Math.floor(t).toString(16),Math.floor(i).toString(16),Math.floor(s).toString(16)];return n=n.map((t,i)=>t.length<2?"0"+t:t),n[0]+n[1]+n[2]}(r.hit.pixel.x*l.x,r.hit.pixel.y*l.y,r.hit.pixel.z*l.z)}}({x:120,y:50,z:120},.8,.2,{x:255,y:255,z:255},l),document.getElementById("myCanvas").getContext("2d")).render()})();