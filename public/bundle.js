(()=>{"use strict";function t(t){let i=Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z);return 0===i?{x:0,y:0,z:0}:{x:t.x/i,y:t.y/i,z:t.z/i}}function i(t,i){return{x:t.x*i,y:t.y*i,z:t.z*i}}function e(t,i){return t.x*i.x+t.y*i.y+t.z*i.z}function r(t,i){return{x:t.x-i.x,y:t.y-i.y,z:t.z-i.z}}function s(t){return t*Math.PI/180}function n(t,i){return{x:t.x+i.x,y:t.y+i.y,z:t.z+i.z}}function a(t,i){return{x:t.y*i.z-t.z*i.y,y:t.z*i.x-t.x*i.z,z:t.x*i.y-t.y*i.x}}const o=class{constructor(t,i,e={x:255,y:20,z:25}){this.radius=i,this.origin=t,this.color=e}ft_sphere_normal(e){let s,n;return n=i(e.direction,e.hit.distance),s=r(n,r(this.origin,e.from)),e.hit.normal=t(s),e.hit.pixel={x:this.color.x,y:this.color.y,z:this.color.z},1}ft_has_intersection(t){let i=r(t.from,this.origin),s={x:e(t.direction,t.direction),y:2*e(t.direction,i),z:e(i,i)-Math.pow(this.radius,2)},n=Math.pow(s.y,2)-s.x*s.z*4,a=[0,0];return n<0?0:(a[0]=-s.y/(2*s.x),n>0&&(n=Math.sqrt(n)),a[0]=(-s.y+n)/(2*s.x),a[1]=(-s.y-n)/(2*s.x),a[0]<0&&a[1]<0?0:(a[0]>a[1]&&a[1]>0&&(a[0]=a[1]),t.hit.distance=a[0],this.ft_sphere_normal(t)))}};class h{constructor(t,i){this.from=t,this.direction=i,this.hit={distance:1e4}}ft_ray_direction(t){let i,e,r;return r=70,i=1*((t.x+.5)/250*2-1),i*=Math.tan(s(35)),e=(t.y+.5)/250*2-1,e*=Math.tan(s(35)),{x:i,y:e,z:1}}hasIntersection(t,i){return t.ft_has_intersection(this)?"#"+i.ft_light(this,t):"#000000"}shadowHasIntersection(t,i){let e=null;for(let r in t){let s=new h(this.from,this.direction);t[r]!==i&&t[r].ft_has_intersection(s)&&s.hit.distance>0&&(null==e||s.hit.distance<e.hit.distance)&&(e=s)}return e}}const l=h,c=class{constructor(t,i,e,r,s){this.origin=t,this.intensity=i,this.ambient=e,this.color=r,this.shapes=s}ft_is_shadow(s,a,o){let h,c,d={},u=n(this.origin,i(s.direction,1e-6));return h=n(s.from,i(s.direction,s.hit.distance)),d.direction=t(r(u,h)),d.from=h,d=new l(d.from,d.direction),u=r(u,h),c=Math.sqrt(e(u,u)),d=d.shadowHasIntersection(a,o),d&&d.hit.distance>0&&d.hit.distance<c?1:0}ft_light(s,a){let o,h,l,c,d;return o=n(s.from,i(s.direction,s.hit.distance)),h=t(r(this.origin,o)),l=s.hit.normal,d=e(h,l),(d<0||this.ft_is_shadow(s,this.shapes,a))&&(d=0),d*=this.intensity,c={x:d+this.ambient*(this.color.x/255),y:d+this.ambient*(this.color.y/255),z:d+this.ambient*(this.color.z/255)},c.x>1&&(c.x=1),c.y>1&&(c.y=1),c.z>1&&(c.z=1),function(t,i,e){let r=[Math.floor(t).toString(16),Math.floor(i).toString(16),Math.floor(e).toString(16)];return r=r.map((t,i)=>t.length<2?"0"+t:t),r[0]+r[1]+r[2]}(s.hit.pixel.x*c.x,s.hit.pixel.y*c.y,s.hit.pixel.z*c.z)}},d=class{constructor(t,i,e,r,s){this.origin=t,this.axis=i,this.fov=e,this.aspectRatio=r/s,this.width=r,this.height=s,this.matrix=this.ft_lookat(this.axis)}ft_ray_direction(t){let i,e,r;return r=this.fov,i=this.aspectRatio*((t.x+.5)/this.width*2-1),i*=Math.tan(s(r/2)),e=(t.y+.5)/this.height*2-1,e*=Math.tan(s(r/2)),{x:i,y:e,z:1}}ft_init_ray(t,i){let e=new l(this.origin,{x:t,y:i,z:1});return e.direction=this.transform_ray(this.ft_ray_direction(e.direction)),e}ft_lookat(i){let r,s,n,o=[];return r={x:0,y:1,z:0},i=t(i),Math.abs(e(i,r))>.999&&(r={x:0,y:0,z:1}),s=t(a(r,i)),n=a(i,s),o[0]=s,o[1]=n,o[2]=i,o}transform_ray(i){let e={},r=this.matrix;return e.x=i.x*r[0].x+i.y*r[1].x+i.z*r[2].x,e.y=i.x*r[0].y+i.y*r[1].y+i.z*r[2].y,e.z=i.x*r[0].z+i.y*r[1].z+i.z*r[2].z,t(e)}},u=class{constructor(t,i,e={x:120,y:255,z:55}){this.direction=t,this.point=i,this.origin=i,this.color=e}ft_has_intersection(s){let n,a,o;return o=e(this.direction,s.direction),Math.abs(o)<=.001?0:(a=e(this.direction,r(this.point,s.from)),n=a/o,s.hit.distance=n,s.hit.normal=t(this.direction),s.hit.pixel=this.color,e(s.direction,s.hit.normal)>0&&(s.hit.normal=i(s.hit.normal,-1)),1)}},m=class{constructor(i,e,r,s,n={x:25,y:155,z:255}){this.radius=s,this.height=r,this.axis=t(e),this.origin=i,this.color=n}ft_caps_normal_intersection(t,s,n){let a,o=r(this.origin,t.from);return a=r(i(t.direction,s[0]),n),t.hit.distance=s[0],t.hit.normal=this.axis,e(a,a)<Math.pow(this.radius,2)&&s[0]>0?(e(t.direction,t.hit.normal)>0&&(t.hit.normal=i(t.hit.normal,-1)),1):(a=r(i(t.direction,s[1]),o),t.hit.normal=this.axis,t.hit.distance=s[1],e(a,a)<Math.pow(this.radius,2)&&s[1]>0?(e(t.direction,t.hit.normal)>0&&(t.hit.normal=i(t.hit.normal,-1)),1):0)}ft_cy_normal(t){let s,n,a,o=r(this.origin,t.from);return n=i(t.direction,t.hit.distance),a=e(this.axis,r(n,o)),s=r(r(n,i(this.axis,a)),o),s=i(s,1/Math.sqrt(e(s,s))),t.hit.normal=s,1}ft_caps_intersection(t){let s,a,o,h=[0,0],l=r(this.origin,t.from);return s=n(l,i(this.axis,this.height)),a=e(this.axis,t.direction),Math.abs(a)<=.001?0:(o=e(this.axis,s),h[0]=o/a,o=e(this.axis,l),h[1]=o/a,this.ft_caps_normal_intersection(t,h,s)?1:0)}ft_cylinder_vars_init(t,i,s){let n=r(this.origin,s.from);t=a(s.direction,this.axis),i.x=e(t,t),i.y=e(t,a(n,this.axis)),i.z=i.x*Math.pow(this.radius,2)-e(this.axis,this.axis)*Math.pow(e(n,t),2)}ft_has_intersection(t){let s={x:0,y:0,z:0},n=[0,0],a=r(this.origin,t.from);return t.hit.pixel=this.color,this.ft_cylinder_vars_init(void 0,s,t),s.z<0||0==s.x?this.ft_caps_intersection(t):(n[0]=(s.y+Math.sqrt(s.z))/s.x,n[1]=(s.y-Math.sqrt(s.z))/s.x,n[0]<0&&n[1]<0?this.ft_caps_intersection(t):(n[0]>n[1]&&n[1]>0&&(n[0]=n[1]),n[1]=e(this.axis,r(i(t.direction,n[0]),a)),n[1]<=0||n[1]>=this.height?this.ft_caps_intersection(t):(t.hit.distance=n[0],this.ft_cy_normal(t))))}};let y=new o({x:0,y:1,z:10},1),x=new u({x:0,y:1,z:0},{x:10,y:-10,z:20},{x:255,y:255,z:255}),g=[y,new m({x:0,y:-10,z:10},{x:0,y:1,z:0},10,1),x],f=new c({x:5,y:5,z:5},.8,.2,{x:255,y:255,z:255},g);const z=document.getElementById("myCanvas").getContext("2d");let b=new class{constructor(t,i,e){this.objects=t,this.light=i,this.ctx=e,this.width=800,this.height=500,this.camera=new d({x:0,y:10,z:-10},{x:0,y:-.5,z:1},60,this.width,this.height)}getPixel(t){let i=1e4,e="#000000",r="#000000",s=new l(t.from,t.direction);for(let n in this.objects)r=s.hasIntersection(this.objects[n],this.light,this.objects),"#000000"!=r&&s.hit.distance>1&&s.hit.distance<i&&(e=r,i=s.hit.distance),n<this.objects.length-1&&(s=new l(t.from,t.direction));return e}render(){let t,i,e;this.ctx.clearRect(0,0,this.width,this.height),this.ctx.fillStyle="#000000";for(let r=0;r<this.width*this.height;r++)t=r%this.width,i=Math.floor(r/this.width),e=this.camera.ft_init_ray(t,i),this.ctx.fillStyle=this.getPixel(e),this.ctx.fillRect(t,this.height-1-i,1,1)}}(g,f,z);b.render();let _=document.getElementById("init"),p=document.getElementById("object"),v="sp",w=document.getElementsByClassName("type-btn");for(let t=0;t<3;t++)w[t].addEventListener("click",t=>{t.preventDefault(),document.getElementById(v).classList.remove("active"),document.getElementById(v+"Fields").classList.remove("active"),t.target.classList.toggle("active"),v=t.target.id,document.getElementById(v+"Fields").classList.toggle("active")});function N(t){const i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return i?{x:parseInt(i[1],16),y:parseInt(i[2],16),z:parseInt(i[3],16)}:{x:0,y:0,z:0}}function M(){const t=document.getElementById("objectsList");if(0===g.length)return void(t.innerHTML='<p style="color: #999; text-align: center;">Aucun objet dans la scène</p>');t.innerHTML=g.map((t,i)=>{let e=(t instanceof o?"Sphere":t instanceof m&&"Cylinder")||"Plan";return e+=` - Position: (${t.origin.x}, ${t.origin.y}, ${t.origin.z})`,t.radius&&(e+=` - Rayon: ${t.radius}`),`\n      <div class="object-item">\n        <div class="object-info">\n          <strong style="color: #${t.color.x.toString(16).padStart(2,"0")}${t.color.y.toString(16).padStart(2,"0")}${t.color.z.toString(16).padStart(2,"0")};">●</strong> ${e}\n        </div>\n        <button class="btn-delete" id="obj-${i}">Supprimer</button>\n      </div>\n    `}).join("");let i=document.getElementsByClassName("btn-delete");for(let t=0;t<i.length;t++)i[t].addEventListener("click",t=>{t.preventDefault();let i=Number(t.target.id.split("-")[1]);delete g[i],M(),b.objects=g,b.render()})}M(),_.addEventListener("submit",t=>{t.preventDefault();let i=new c({x:Number(t.target.lightPosX.value),y:Number(t.target.lightPosY.value),z:Number(t.target.lightPosZ.value)},Number(t.target.lightIntensity.value),Number(t.target.ambientIntensity.value),N(t.target.ambientColor.value),g),e=new d({x:Number(t.target.camPosX.value),y:Number(t.target.camPosY.value),z:Number(t.target.camPosZ.value)},{x:Number(t.target.camRotX.value),y:Number(t.target.camRotY.value),z:Number(t.target.camRotZ.value)},Number(t.target.camFov.value),b.width,b.height);b.light=i,b.camera=e,b.render()}),p.addEventListener("submit",t=>{t.preventDefault();let i={x:Number(t.target.objPosX.value),y:Number(t.target.objPosY.value),z:Number(t.target.objPosZ.value)},e=N(t.target.objColor.value);switch(v){case"sp":g.push(new o(i,Number(t.target.sphereRadius.value),e));break;case"cy":g.push(new m(i,{x:Number(t.target.cylinderOrientX.value),y:Number(t.target.cylinderOrientY.value),z:Number(t.target.cylinderOrientZ.value)},Number(t.target.cylinderSize.value),Number(t.target.cylinderRadius.value),e)),console.log(g);break;case"pl":g.push(new u({x:Number(t.target.planeNormalX.value),y:Number(t.target.planeNormalY.value),z:Number(t.target.planeNormalZ.value)},i,e))}M(),b.render()})})();